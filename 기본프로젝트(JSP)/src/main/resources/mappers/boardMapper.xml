<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.board.repository.BoardMapper">

	<insert id="insertBoard" parameterType="Map">
		INSERT INTO POSTS
		     ( POSTS_NO
		     , USER_NO
		     , POSTS_TITLE
		     , POSTS_CONTENT
		     , DEL_YN
		     , REG_DTM
		     , REG_NO
		     , UPD_DTM
		     , UPD_NO 
		     )			
		VALUES
		     ( SEQ_POSTS_NO.NEXTVAL
		     , #{userNo}
		     , #{postsTitle}
		     , #{postsContent}
		     , 'N'
		     , SYSDATE
		     , #{userNo}
		     , SYSDATE
		     , #{userNo}
		     )
	</insert>
	
	<select id="selectPostsNo" parameterType="Map" resultType="int">
		SELECT MAX(POSTS_NO) AS POSTS_NO
		  FROM POSTS
		 WHERE USER_NO = #{userNo}
	</select>
	
	<select id="selectBoardCnt" resultType="int">
		SELECT COUNT(*)
		  FROM POSTS
	</select>
	
	<select id="selectBoardList" parameterType="int" resultType="Map">
		SELECT RN 
		     , POSTS_NO
		     , REG_DTM
		     , POSTS_TITLE
		     , USER_NM
		     , REPLY_CNT
    	  FROM (SELECT ROWNUM RN
    			     , POSTS_NO
				     , POSTS_TITLE
				     , REG_DTM
				     , USER_NM
				     , REPLY_CNT
            	  FROM (SELECT A.POSTS_NO
						     , A.POSTS_TITLE
						     , A.REG_DTM
						     , B.USER_NM
						     , (SELECT COUNT(*)
						          FROM COMMENTS C
						         WHERE A.POSTS_NO = C.POSTS_NO
						        ) AS REPLY_CNT
						  FROM POSTS  A
						     , USER_D B
						 WHERE A.USER_NO = B.USER_NO
						   AND A.DEL_YN = 'N'
						 ORDER BY POSTS_NO DESC
   					   ) 
   			   )
         WHERE RN BETWEEN (#{pageCnt}-1)*10 + 1 and #{pageCnt}*10
			
	</select>
	
	<select id="selectBoardDetail" parameterType="int" resultType="Map">
		SELECT POSTS_NO
		     , POSTS_CONTENT
		     , POSTS_TITLE
		     , USER_NM
		     , USER_NO
		  FROM (SELECT A.POSTS_NO
		             , A.POSTS_CONTENT
		             , A.POSTS_TITLE
		             , B.USER_NM
		             , B.USER_NO
		          FROM POSTS  A
		             , USER_D B
		         WHERE A.USER_NO = B.USER_NO
		           AND A.POSTS_NO = #{postNo}
		        )
	  ORDER BY POSTS_NO DESC
	</select>
	
	<select id="selectCommentList" parameterType="int"  resultType="Map">
		SELECT LEVEL AS COMMENT_LEVEL
             , A.COMMENTS_NO
             , A.PARENT_NO
             , A.COMMENTS_CONTENT
             , TO_CHAR(A.REG_DTM, 'YYYY-MM-DD HH24:MI:SS') AS REG_DTM
             , A.DEL_YN 
             , B.USER_NM
             , B.USER_NO
          FROM COMMENTS A
             , USER_D B
         WHERE A.USER_NO = B.USER_NO
           AND A.POSTS_NO = #{postsNo}
         START WITH A.PARENT_NO IS NULL
       CONNECT BY PRIOR A.COMMENTS_NO = A.PARENT_NO
         ORDER SIBLINGS BY A.REG_DTM
	</select>
	
	<update id="deleteBoard">
		UPDATE POSTS
		   SET DEL_YN = 'Y'
		 WHERE POSTS_NO = #{postsNo}
	</update>
	
	<update id="updatePosts" parameterType="Map" >
		UPDATE POSTS
		   SET POSTS_TITLE = #{postsTitle}
		     , POSTS_CONTENT = #{postsContent}
		     , UPD_DTM = SYSDATE
		     , UPD_NO = #{userNo}
		 WHERE POSTS_NO = #{postsNo}
	</update> 
	
	<insert id="insertComment" parameterType="Map">
	    INSERT INTO COMMENTS 
	         ( COMMENTS_NO
	         , POSTS_NO
	         , PARENT_NO
	         , COMMENTS_CONTENT
	         , USER_NO
	         , DEL_YN
	         , REG_DTM
	         , REG_NO
	         ) 
	    VALUES 
	         ( COMMENTS_SEQ.NEXTVAL
	         , #{postsNo}
	         , #{parentNo, jdbcType=NUMERIC} <!-- null 가능 -->
	         , #{commentsContent}
	         , #{userNo}
	         , 'N'
	         , SYSDATE
	         , #{userNo}
	         )
	</insert>
	
	<update id="updateComment" parameterType="Map" >
		UPDATE COMMENTS
		   SET COMMENTS_CONTENT = #{commentsContent}
	     WHERE COMMENTS_NO = #{commentsNo}
	</update>  
	
	<update id="deleteComment" parameterType="int">
		UPDATE COMMENTS
		   SET DEL_YN = 'Y'
		 WHERE COMMENTS_NO = #{commentsNo}
	</update>

	<select id="selectFileList" parameterType="int" resultType="Map">
		SELECT FILE_NAME
		     , POSTS_NO
		     , REG_DTM
		  FROM FILES
   		 WHERE POSTS_NO = ${postsNo}
	  ORDER BY REG_DTM DESC
	</select> 

    <insert id="saveFile" parameterType="Map" >
    	INSERT INTO FILES
    	     ( FILE_NAME
    	     , POSTS_NO
    	     , REG_DTM
    	     )
	    VALUES 
	         ( #{fileName}
		   	 , #{postsNo}
		     , SYSDATE
			 )
    </insert>
    
    <delete id="deleteFile" parameterType="Map" >
    	DELETE 
    	  FROM FILES
    	 WHERE POSTS_NO = #{postsNo}
	</delete>
</mapper>